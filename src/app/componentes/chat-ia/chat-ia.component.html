<!-- â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” -->
<!-- COMPONENTE DE CHAT CON IA                                           -->
<!-- â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” -->

<div class="chat-container">

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <!-- HEADER                                                             -->
    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="chat-header">
        <div class="header-left">
            <h2>ğŸ¤– Planificador de Viajes con IA</h2>
            <span class="session-id">SesiÃ³n: {{ sessionId.substring(0, 8) }}...</span>
        </div>

        <div class="header-right">
            <!-- Indicador API Key -->
            <button class="btn-header btn-api-key" [class.configurada]="apiKeyConfigurada"
                (click)="apiKeyConfigurada ? eliminarApiKey() : configurarApiKey()"
                [title]="apiKeyConfigurada ? 'API Key configurada (click para eliminar)' : 'Configurar API Key'">
                <span *ngIf="apiKeyConfigurada">ğŸ”‘ âœ“</span>
                <span *ngIf="!apiKeyConfigurada">ğŸ”‘ âœ—</span>
            </button>

            <!-- Nueva conversaciÃ³n -->
            <button class="btn-header btn-nueva" (click)="nuevaConversacion()" title="Nueva conversaciÃ³n">
                ğŸ”„
            </button>

            <!-- Limpiar historial -->
            <button class="btn-header btn-limpiar" (click)="limpiarHistorial()" [disabled]="mensajes.length === 0"
                title="Limpiar historial">
                ğŸ—‘ï¸
            </button>
        </div>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <!-- PANEL DE PLAN DETECTADO                                           -->
    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="plan-panel" *ngIf="planDetectado">
        <div class="plan-header">
            <div class="plan-title">
                <span class="plan-icon">âœ¨</span>
                <h3>Plan de Viaje Generado</h3>
            </div>
            <button class="btn-close-plan" (click)="planDetectado = null" title="Cerrar">âœ•</button>
        </div>

        <div class="plan-body">
            <div class="plan-info">
                <div class="info-item">
                    <strong>ğŸ“ Destino:</strong>
                    <span>{{ planDetectado.viaje.destino }}</span>
                </div>
                <div class="info-item">
                    <strong>ğŸ“… Fechas:</strong>
                    <span>{{ planDetectado.viaje.fecha_inicio }} â†’ {{ planDetectado.viaje.fecha_fin }}</span>
                </div>
                <div class="info-item">
                    <strong>ğŸ—“ï¸ Itinerarios:</strong>
                    <span>{{ planDetectado.itinerarios.length }} dÃ­as</span>
                </div>
                <div class="info-item">
                    <strong>ğŸ¯ Actividades:</strong>
                    <span>{{ contarActividades(planDetectado) }} actividades</span>
                </div>
            </div>

            <div class="plan-actions">
                <button class="btn-plan" (click)="toggleMostrarJson()">
                    {{ mostrarJson ? 'ğŸ“‹ Ocultar JSON' : 'ğŸ“‹ Ver JSON' }}
                </button>
                <button class="btn-plan btn-copiar" (click)="copiarJson()">
                    ğŸ“‹ Copiar JSON
                </button>
            </div>

            <!-- JSON expandible -->
            <div class="json-container" *ngIf="mostrarJson">
                <pre>{{ planDetectado | json }}</pre>
            </div>
        </div>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <!-- ÃREA DE MENSAJES                                                  -->
    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="mensajes-container" #mensajesContainer>

        <!-- Mensaje de bienvenida si no hay mensajes -->
        <div class="bienvenida" *ngIf="mensajes.length === 0">
            <div class="bienvenida-icon">ğŸ—ºï¸</div>
            <h3>Â¡Hola! Soy tu asistente de viajes</h3>
            <p>Puedo ayudarte a planificar tu prÃ³ximo viaje. CuÃ©ntame:</p>
            <ul>
                <li>Â¿A dÃ³nde quieres ir?</li>
                <li>Â¿CuÃ¡ntos dÃ­as?</li>
                <li>Â¿QuÃ© tipo de actividades te gustan?</li>
            </ul>
            <div class="ejemplo">
                <strong>Ejemplo:</strong> "Quiero ir a Barcelona 3 dÃ­as, me gusta la cultura y la gastronomÃ­a"
            </div>
        </div>

        <!-- Lista de mensajes -->
        <div class="mensaje" *ngFor="let mensaje of mensajes" [class.usuario]="mensaje.rol === 'user'"
            [class.asistente]="mensaje.rol === 'assistant'">

            <div class="mensaje-avatar">
                <span *ngIf="mensaje.rol === 'user'">ğŸ‘¤</span>
                <span *ngIf="mensaje.rol === 'assistant'">ğŸ¤–</span>
            </div>

            <div class="mensaje-contenido">
                <div class="mensaje-texto">{{ mensaje.mensaje }}</div>

                <div class="mensaje-meta">
                    <span class="timestamp" *ngIf="mensaje.timestamp">
                        {{ formatearFecha(mensaje.timestamp) }}
                    </span>
                    <span class="tokens" *ngIf="mensaje.tokens_usados">
                        ğŸª™ {{ mensaje.tokens_usados }} tokens
                    </span>
                    <span class="tiempo" *ngIf="mensaje.tiempo_respuesta">
                        â±ï¸ {{ mensaje.tiempo_respuesta }}ms
                    </span>
                </div>
            </div>
        </div>

        <!-- Indicador de carga -->
        <div class="mensaje asistente cargando-mensaje" *ngIf="cargando">
            <div class="mensaje-avatar">
                <span>ğŸ¤–</span>
            </div>
            <div class="mensaje-contenido">
                <div class="typing-indicator">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
                <div class="mensaje-meta">
                    <span>La IA estÃ¡ escribiendo...</span>
                </div>
            </div>
        </div>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <!-- INPUT DE MENSAJE                                                  -->
    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="input-container">
        <textarea [(ngModel)]="mensajeActual" (keydown)="onKeydown($event)" [disabled]="cargando"
            placeholder="Escribe tu mensaje... (Enter para enviar, Shift+Enter para nueva lÃ­nea)" rows="1"
            class="mensaje-input">
    </textarea>

        <button class="btn-enviar" (click)="enviarMensaje()" [disabled]="!mensajeActual.trim() || cargando"
            [class.cargando]="cargando">
            <span *ngIf="!cargando">ğŸ“¤</span>
            <span *ngIf="cargando" class="spinner"></span>
        </button>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <!-- FOOTER CON INFO                                                   -->
    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="chat-footer">
        <!-- âœ¨ NUEVO: Barra de progreso de tokens -->
        <div class="tokens-progress" *ngIf="limiteTokens">
            <div class="tokens-info">
                <span class="tokens-label">ğŸª™ Consumo de tokens:</span>
                <span class="tokens-numeros">
                    {{ limiteTokens.consumidos.toLocaleString('es-ES') }} /
                    {{ limiteTokens.maximo.toLocaleString('es-ES') }}
                </span>
                <span class="tokens-porcentaje" [class.warning]="limiteTokens.porcentaje_usado >= 75"
                    [class.danger]="limiteTokens.porcentaje_usado >= 90">
                    ({{ limiteTokens.porcentaje_usado }}%)
                </span>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" [style.width.%]="limiteTokens.porcentaje_usado"
                    [class.warning]="limiteTokens.porcentaje_usado >= 75"
                    [class.danger]="limiteTokens.porcentaje_usado >= 90">
                </div>
            </div>
            <div class="tokens-restantes">
                <small>
                    Quedan {{ limiteTokens.restantes.toLocaleString('es-ES') }} tokens disponibles
                </small>
            </div>
        </div>

        <small class="footer-text">
            Powered by Perplexity AI â€¢
            {{ mensajes.length }} mensajes â€¢
            <span *ngIf="!apiKeyConfigurada" class="advertencia">âš ï¸ API Key no configurada</span>
            <span *ngIf="apiKeyConfigurada" class="ok">âœ“ API Key configurada</span>
        </small>
    </div>


</div>