<div class="contenedor">
  <h2>Actividades para el itinerario {{ itinerarioId }}</h2>

  <!-- Bot√≥n para a√±adir una nueva actividad -->
  <button [routerLink]="['/formulario-actividad', viajePrevistoId, itinerarioId, 'nuevo']" class="btn-agregar">
    <i class="fa fa-plus-circle"></i> A√±adir Actividad
  </button>

  <hr>

  <!-- Lista de actividades -->
  <div *ngFor="let actividad of actividades">
    <h3>Actividad {{ actividad.id }}</h3>
    <p><strong>Nombre:</strong> {{ actividad.nombre }}</p>
    <p><strong>Descripci√≥n:</strong> {{ actividad.descripcion }}</p>
    <p><strong>Horario:</strong> {{ actividad.horaInicio }} a {{ actividad.horaFin }}</p>

    <!-- ‚ú® CONTENEDOR DE BOTONES DE ACCI√ìN -->
    <div class="acciones-actividad">
      <button class="btn-eliminar" (click)="eliminarActividad(actividad.id)">
        <i class="fa fa-trash"></i> Eliminar
      </button>
      <button class="btn-actualizar" (click)="actualizarActividad(actividad)">
        <i class="fa fa-edit"></i> Actualizar
      </button>
      <button class="btn-ver-archivos" (click)="verArchivos(actividad.id, $event)">
        <i class="fa fa-folder-open"></i> Ver Archivos
      </button>

      <!-- ‚ú® NUEVOS BOTONES -->
      <button class="btn-gpx" (click)="verGPX(actividad.id)">
        <i class="fa fa-map-marker"></i> Ver GPX
      </button>
      <button class="btn-mapa" (click)="verMapa(actividad.id)">
        <i class="fa fa-image"></i> Ver Mapa
      </button>
      <button class="btn-estadisticas" (click)="verEstadisticas(actividad.id)">
        <i class="fa fa-bar-chart"></i> Estad√≠sticas
      </button>
    </div>

    <hr>
  </div>

  <button (click)="volverAItinerarios()">
    <i class="fa fa-arrow-left"></i> Volver a Itinerarios
  </button>
</div>

<!-- ‚ú® MODAL MAPA PNG -->
<div class="modal" *ngIf="mostrarModalMapa" (click)="cerrarModalMapa()">
  <div class="modal-contenido" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>üìç Mapa del Recorrido</h3>
      <button class="btn-cerrar" (click)="cerrarModalMapa()">‚úï</button>
    </div>
    <div class="modal-body">
      <img [src]="urlMapaDataURL" alt="Mapa del recorrido" class="mapa-imagen">
    </div>
  </div>
</div>

<!-- ‚ú® MODAL ESTAD√çSTICAS -->
<div class="modal" *ngIf="mostrarModalEstadisticas" (click)="cerrarModalEstadisticas()">
  <div class="modal-contenido modal-estadisticas" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>üìä Estad√≠sticas del Recorrido</h3>
      <button class="btn-cerrar" (click)="cerrarModalEstadisticas()">‚úï</button>
    </div>
    <div class="modal-body" *ngIf="estadisticasActuales">

      <!-- 1. RESUMEN PRINCIPAL -->
      <div class="estadistica-grupo">
        <h4><i class="fa fa-info-circle"></i> Resumen</h4>
        <div class="stat-item highligth">
          <span class="label">Distancia:</span>
          <span class="value">{{ estadisticasActuales.distancia.km }} km</span>
        </div>
        <div class="stat-item highligth">
          <span class="label">Duraci√≥n:</span>
          <span class="value">{{ estadisticasActuales.duracion.formateada }}</span>
        </div>
        <div class="stat-item">
          <span class="label">Velocidad Media:</span>
          <span class="value">{{ estadisticasActuales.velocidad.media }} km/h</span>
        </div>
        <div class="stat-item">
          <span class="label">Pasos Totales:</span>
          <span class="value">{{ estadisticasActuales.energia.pasos }}</span>
        </div>
      </div>

      <!-- 2. RENDIMIENTO -->
      <div class="estadistica-grupo">
        <h4><i class="fa fa-bolt"></i> Rendimiento</h4>
        <div class="stat-item">
          <span class="label">Velocidad M√°xima:</span>
          <span class="value">{{ estadisticasActuales.velocidad.maxima }} km/h</span>
        </div>
        <div class="stat-item" *ngIf="estadisticasActuales.ritmo.medio">
          <span class="label">Ritmo Medio:</span>
          <span class="value">{{ estadisticasActuales.ritmo.medio }} min/km</span>
        </div>
        <div class="stat-item" *ngIf="estadisticasActuales.ritmo.maximo">
          <span class="label">Ritmo M√°ximo:</span>
          <span class="value">{{ estadisticasActuales.ritmo.maximo }} min/km</span>
        </div>
        <div class="stat-item">
          <span class="label">Calor√≠as:</span>
          <span class="value">{{ estadisticasActuales.energia.calorias }} kcal</span>
        </div>
      </div>

      <!-- 3. TIEMPOS DETALLADOS -->
      <div class="estadistica-grupo" *ngIf="estadisticasActuales.tiempos">
        <h4><i class="fa fa-clock-o"></i> Tiempos</h4>
        <div class="stat-item" *ngIf="estadisticasActuales.tiempos.enMarcha">
          <span class="label">En Marcha:</span>
          <span class="value">{{ estadisticasActuales.tiempos.enMarcha }}</span>
        </div>
        <div class="stat-item" *ngIf="estadisticasActuales.tiempos.parado">
          <span class="label">Parado:</span>
          <span class="value">{{ estadisticasActuales.tiempos.parado }}</span>
        </div>
        <div class="stat-item" *ngIf="estadisticasActuales.tiempos.pausado">
          <span class="label">Pausado:</span>
          <span class="value">{{ estadisticasActuales.tiempos.pausado }}</span>
        </div>
      </div>

      <!-- 4. ALTITUD -->
      <div class="estadistica-grupo"
        *ngIf="estadisticasActuales.altitud && estadisticasActuales.altitud.ganancia !== null">
        <h4><i class="fa fa-area-chart"></i> Altitud</h4>
        <div class="stat-item">
          <span class="label">Ganancia (Ascenso):</span>
          <span class="value">{{ estadisticasActuales.altitud.ganancia }} m</span>
        </div>
        <div class="stat-item">
          <span class="label">P√©rdida (Descenso):</span>
          <span class="value">{{ estadisticasActuales.altitud.perdida }} m</span>
        </div>
        <div class="stat-item">
          <span class="label">Altitud M√≠nima:</span>
          <span class="value">{{ estadisticasActuales.altitud.min }} m</span>
        </div>
        <div class="stat-item">
          <span class="label">Altitud M√°xima:</span>
          <span class="value">{{ estadisticasActuales.altitud.max }} m</span>
        </div>
      </div>

      <!-- 5. T√âCNICA & APP -->
      <div class="estadistica-grupo">
        <h4><i class="fa fa-microchip"></i> T√©cnica & App</h4>
        <div class="stat-item">
          <span class="label">Puntos GPS:</span>
          <span class="value">{{ estadisticasActuales.tracking.puntosGPS }}</span>
        </div>
        <div class="stat-item">
          <span class="label">Perfil:</span>
          <span class="value">{{ estadisticasActuales.tracking.perfilTransporte }}</span>
        </div>
        <div class="stat-item" *ngIf="estadisticasActuales.app.dispositivo">
          <span class="label">Dispositivo:</span>
          <span class="value">{{ estadisticasActuales.app.dispositivo }}</span>
        </div>
      </div>

      <!-- 6. DESGLOSE IDA Y VUELTA (NUEVO - Full Width) -->
      <div class="estadistica-grupo grupo-full" *ngIf="estadisticasActuales.idaVuelta">
        <h4><i class="fa fa-exchange"></i> Desglose Ida y Vuelta</h4>
        <div class="desglose-grid">
          <div class="segmento-transporte color-ida">
            <p><strong>IDA:</strong> {{ estadisticasActuales.idaVuelta.ida.km }} km ({{
              estadisticasActuales.idaVuelta.ida.tiempo }})</p>
          </div>
          <div class="segmento-transporte color-vuelta">
            <p><strong>VUELTA:</strong> {{ estadisticasActuales.idaVuelta.vuelta.km }} km ({{
              estadisticasActuales.idaVuelta.vuelta.tiempo }})</p>
          </div>
        </div>
      </div>

      <!-- 5. DESGLOSE TRANSPORTE (Full Width) -->
      <div class="estadistica-grupo grupo-full"
        *ngIf="estadisticasActuales.desgloseTransporte && estadisticasActuales.desgloseTransporte.length > 0">
        <h4><i class="fa fa-bicycle"></i> Desglose por Transporte</h4>
        <div class="desglose-grid">
          <div *ngFor="let seg of estadisticasActuales.desgloseTransporte" class="segmento-transporte">
            <p>
              <strong>{{ seg.nombre }}:</strong>
              {{ seg.distanciaKm || (seg.distanciaMetros / 1000).toFixed(2) }} km
              ({{ seg.duracionFormateada || seg.tiempoEmpleado }})
            </p>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>

<!-- ‚úÖ MODAL MAPA GPX MEJORADO CON PANEL Y FABS -->
<div class="modal" *ngIf="mostrarModalGPXMapa" (click)="cerrarModalGPXMapa()">
  <div class="modal-contenido modal-mapa-gpx-full" (click)="$event.stopPropagation()">

    <!-- Header del modal -->
    <div class="modal-header">
      <h3>üìç Recorrido GPX</h3>
      <button class="btn-cerrar" (click)="cerrarModalGPXMapa()">‚úï</button>
    </div>

    <!-- ‚úÖ NUEVO: Contenedor del mapa con vista flexible -->
    <div class="map-view-container">
      <!-- Mapa Leaflet -->
      <div id="mapa-gpx-container" class="mapa-gpx-interactive"></div>

      <!-- ‚úÖ Panel de Estad√≠sticas Contra√≠ble -->
      <div class="map-info" *ngIf="showStatsPanel" [class.collapsed]="!panelExpanded" [class.expanded]="panelExpanded"
        (click)="togglePanelExpanded()">
        <div class="info-card">

          <!-- Vista Contra√≠da (4 datos principales) -->
          <div class="stats-main" *ngIf="!panelExpanded">

            <!-- Indicador de transporte -->
            <div class="transport-indicator" *ngIf="estadisticasGPX.transportePrincipal">
              <span class="transport-emoji">{{ getTransportEmoji(estadisticasGPX.transportePrincipal?.icono || '')
                }}</span>
              <span class="transport-name">{{ estadisticasGPX.transportePrincipal?.nombre || 'Desconocido' }}</span>
            </div>

            <!-- Grid 2x2 para los 4 datos principales -->
            <div class="stats-grid">
              <!-- Distancia -->
              <div class="stat-item-large">
                <div class="stat-label">Distancia</div>
                <div class="stat-value">{{ estadisticasGPX.distanciaKm || '0.00' }}<span class="stat-unit">km</span>
                </div>
              </div>

              <!-- Tiempo -->
              <div class="stat-item-large">
                <div class="stat-label">Tiempo</div>
                <div class="stat-value">{{ estadisticasGPX.duracion?.formateada || '00:00:00' }}</div>
              </div>

              <!-- Velocidad Media -->
              <div class="stat-item-large">
                <div class="stat-label">Vel. Media</div>
                <div class="stat-value">{{ estadisticasGPX.velocidad?.media || '0.0' }}<span
                    class="stat-unit">km/h</span></div>
              </div>

              <!-- Tiempo Pausado -->
              <div class="stat-item-large" *ngIf="(estadisticasGPX.tiempoPausaSegundos || 0) > 0">
                <div class="stat-label">Pausado</div>
                <div class="stat-value">{{ formatDuration((estadisticasGPX.tiempoPausaSegundos || 0) * 1000) }}</div>
              </div>
            </div>

            <!-- Indicador visual para expandir -->
            <div class="expand-hint">
              <span class="icon">‚ñº</span>
              <span>Toca para ver m√°s</span>
            </div>

          </div>

          <!-- Vista Expandida (estad√≠sticas completas) -->
          <div class="stats-detail" *ngIf="panelExpanded">

            <!-- T√≠tulo -->
            <p class="info-title"><strong>üìä Estad√≠sticas Completas</strong></p>
            <div class="divider"></div>

            <!-- Grid de estad√≠sticas -->
            <div class="stats-grid">
              <p class="info-text"><strong>Distancia:</strong> {{ estadisticasGPX.distanciaKm || '0.00' }} km</p>
              <p class="info-text"><strong>Tiempo:</strong> {{ estadisticasGPX.duracion?.formateada || '00:00:00' }}</p>
              <p class="info-text" *ngIf="estadisticasGPX.fecha"><strong>Fecha:</strong> {{ estadisticasGPX.fecha }}</p>
              <p class="info-text" *ngIf="estadisticasGPX.horario?.inicio"><strong>Inicio:</strong> {{
                estadisticasGPX.horario?.inicio }}</p>
              <p class="info-text" *ngIf="estadisticasGPX.horario?.fin"><strong>Fin:</strong> {{
                estadisticasGPX.horario?.fin }}</p>
              <p class="info-text" *ngIf="(estadisticasGPX.energia?.pasos || 0) > 0"><strong>Pasos:</strong> {{
                estadisticasGPX.energia?.pasos }}</p>
              <p class="info-text" *ngIf="(estadisticasGPX.energia?.calorias || 0) > 0"><strong>Calor√≠as:</strong> {{
                estadisticasGPX.energia?.calorias }} kcal</p>
              <p class="info-text"><strong>V. Media:</strong> {{ estadisticasGPX.velocidad?.media || '0.0' }} km/h</p>
              <p class="info-text"><strong>V. M√°xima:</strong> {{ estadisticasGPX.velocidad?.maxima || '0.0' }} km/h</p>
              <p class="info-text"><strong>Puntos GPS:</strong> {{ estadisticasGPX.tracking?.puntosGPS || 0 }}</p>
            </div>

            <!-- Desglose Ida y Vuelta -->
            <div class="turning-stats" *ngIf="estadisticasGPX.tieneIdaVuelta">
              <div class="divider"></div>
              <h3 class="subsection-title">üîÑ Desglose Ida y Vuelta</h3>
              <div class="stats-grid split-stats">
                <div class="split-column outbound">
                  <div class="split-header">üîπ IDA</div>
                  <div class="split-data">
                    <span class="value">{{ formatDistance(estadisticasGPX.distanciaIdaMetros || 0) }}</span>
                    <span class="time">{{ estadisticasGPX.tiempoIdaFormateado || '00:00:00' }}</span>
                  </div>
                </div>
                <div class="split-column return">
                  <div class="split-header">üî∏ VUELTA</div>
                  <div class="split-data">
                    <span class="value">{{ formatDistance(estadisticasGPX.distanciaVueltaMetros || 0) }}</span>
                    <span class="time">{{ estadisticasGPX.tiempoVueltaFormateado || '00:00:00' }}</span>
                  </div>
                </div>
              </div>
            </div>

            <!-- Desglose por transporte -->
            <div class="transport-breakdown"
              *ngIf="estadisticasGPX.desgloseTransporte && estadisticasGPX.desgloseTransporte.length > 0">
              <div class="divider"></div>
              <h3 class="subsection-title">üö∂ Desglose por Transporte</h3>
              <div class="transport-item" *ngFor="let item of estadisticasGPX.desgloseTransporte">
                <span>{{ item?.nombre || 'Desconocido' }}: {{ item?.distanciaKm || '0.00' }} km ({{
                  item?.duracionFormateada || '00:00:00' }})</span>
              </div>
            </div>

            <!-- Indicador visual para contraer -->
            <div class="collapse-hint">
              <span class="icon">‚ñ≤</span>
              <span>Toca para contraer</span>
            </div>

          </div>

        </div>
      </div>

      <!-- ‚úÖ NUEVO: FABs Flotantes -->
      <div class="fab-container">
        <!-- FAB: Ajustar vista -->
        <button class="fab fab-success" (click)="fitMapToTrack()" title="Ajustar vista">
          <span class="fab-icon">üîç</span>
        </button>

        <!-- FAB: Toggle panel -->
        <button class="fab" [class.fab-primary]="showStatsPanel" [class.fab-medium]="!showStatsPanel"
          (click)="toggleMapView()" title="Toggle panel">
          <span class="fab-icon">{{ showStatsPanel ? 'üìä' : 'üó∫Ô∏è' }}</span>
        </button>
      </div>

    </div>
  </div>
</div>